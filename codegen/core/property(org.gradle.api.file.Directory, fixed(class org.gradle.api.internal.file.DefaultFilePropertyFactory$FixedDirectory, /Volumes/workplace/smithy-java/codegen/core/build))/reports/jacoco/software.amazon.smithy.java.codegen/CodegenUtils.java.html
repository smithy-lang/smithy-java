<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CodegenUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">software.amazon.smithy.java.codegen</a> &gt; <span class="el_source">CodegenUtils.java</span></div><h1>CodegenUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * SPDX-License-Identifier: Apache-2.0
 */

package software.amazon.smithy.java.codegen;

import java.net.URL;
import java.util.List;
import java.util.Locale;
import java.util.Objects;
import java.util.stream.Collectors;
import software.amazon.smithy.codegen.core.ReservedWords;
import software.amazon.smithy.codegen.core.ReservedWordsBuilder;
import software.amazon.smithy.codegen.core.Symbol;
import software.amazon.smithy.codegen.core.SymbolProvider;
import software.amazon.smithy.java.codegen.writer.JavaWriter;
import software.amazon.smithy.java.runtime.core.schema.PreludeSchemas;
import software.amazon.smithy.model.Model;
import software.amazon.smithy.model.loader.Prelude;
import software.amazon.smithy.model.shapes.MemberShape;
import software.amazon.smithy.model.shapes.ServiceShape;
import software.amazon.smithy.model.shapes.Shape;
import software.amazon.smithy.model.traits.StreamingTrait;
import software.amazon.smithy.utils.CaseUtils;
import software.amazon.smithy.utils.SmithyInternalApi;
import software.amazon.smithy.utils.StringUtils;

/**
 * Provides utility methods for generating Java code.
 */
@SmithyInternalApi
public final class CodegenUtils {
<span class="fc" id="L34">    private static final URL RESERVED_WORDS_FILE = Objects.requireNonNull(</span>
<span class="fc" id="L35">        CodegenUtils.class.getResource(&quot;reserved-words.txt&quot;)</span>
    );

    private static final String SCHEMA_STATIC_NAME = &quot;SCHEMA&quot;;
<span class="fc" id="L39">    public static final ReservedWords SHAPE_ESCAPER = new ReservedWordsBuilder()</span>
<span class="fc" id="L40">        .loadCaseInsensitiveWords(RESERVED_WORDS_FILE, word -&gt; word + &quot;Shape&quot;)</span>
<span class="fc" id="L41">        .build();</span>
<span class="fc" id="L42">    public static final ReservedWords MEMBER_ESCAPER = new ReservedWordsBuilder()</span>
<span class="fc" id="L43">        .loadCaseInsensitiveWords(RESERVED_WORDS_FILE, word -&gt; word + &quot;Member&quot;)</span>
<span class="fc" id="L44">        .build();</span>

    private CodegenUtils() {
        // Utility class should not be instantiated
    }

    /**
     * Gets a Smithy codegen {@link Symbol} for a Java class.
     *
     * @param clazz class to get symbol for.
     * @return Symbol representing the provided class.
     */
    public static Symbol fromClass(Class&lt;?&gt; clazz) {
<span class="fc" id="L57">        return Symbol.builder()</span>
<span class="fc" id="L58">            .name(clazz.getSimpleName())</span>
<span class="fc" id="L59">            .namespace(clazz.getCanonicalName().replace(&quot;.&quot; + clazz.getSimpleName(), &quot;&quot;), &quot;.&quot;)</span>
<span class="fc" id="L60">            .putProperty(SymbolProperties.IS_PRIMITIVE, clazz.isPrimitive())</span>
<span class="fc" id="L61">            .putProperty(SymbolProperties.REQUIRES_STATIC_DEFAULT, true)</span>
<span class="fc" id="L62">            .build();</span>
    }

    /**
     * Gets a Symbol for a class with both a boxed and unboxed variant.
     *
     * @param boxed Boxed variant of class
     * @param unboxed Unboxed variant of class
     * @return Symbol representing java class
     */
    public static Symbol fromBoxedClass(Class&lt;?&gt; unboxed, Class&lt;?&gt; boxed) {
<span class="fc" id="L73">        return fromClass(unboxed).toBuilder()</span>
<span class="fc" id="L74">            .putProperty(SymbolProperties.IS_PRIMITIVE, true)</span>
<span class="fc" id="L75">            .putProperty(SymbolProperties.BOXED_TYPE, fromClass(boxed))</span>
<span class="fc" id="L76">            .putProperty(SymbolProperties.REQUIRES_STATIC_DEFAULT, false)</span>
<span class="fc" id="L77">            .build();</span>
    }

    /**
     * Gets the default class name to use for a given Smithy {@link Shape}.
     *
     * @param shape Shape to get name for.
     * @return Default name.
     */
    public static String getDefaultName(Shape shape, ServiceShape service) {
<span class="fc" id="L87">        String baseName = shape.getId().getName(service);</span>

        // If the name contains any problematic delimiters, use PascalCase converter,
        // otherwise, just capitalize first letter to avoid messing with user-defined
        // capitalization.
        String unescaped;
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if (baseName.contains(&quot;_&quot;)) {</span>
<span class="nc" id="L94">            unescaped = CaseUtils.toPascalCase(shape.getId().getName());</span>
        } else {
<span class="fc" id="L96">            unescaped = StringUtils.capitalize(baseName);</span>
        }

<span class="fc" id="L99">        return SHAPE_ESCAPER.escape(unescaped);</span>
    }

    /**
     * Determines if a shape is a streaming blob.
     *
     * @param shape shape to check
     * @return returns true if the shape is a streaming blob
     */
    public static boolean isStreamingBlob(Shape shape) {
<span class="pc bpc" id="L109" title="3 of 4 branches missed.">        return shape.isBlobShape() &amp;&amp; shape.hasTrait(StreamingTrait.class);</span>
    }

    /**
     * Checks if a symbol resolves to a Java Array type.
     *
     * @param symbol symbol to check
     * @return true if symbol resolves to a Java Array
     */
    public static boolean isJavaArray(Symbol symbol) {
<span class="fc" id="L119">        return symbol.getProperty(SymbolProperties.IS_JAVA_ARRAY).isPresent();</span>
    }

    /**
     * Determines if a given member represents a nullable type
     *
     * @param shape member to check for nullability
     *
     * @return if the shape is a nullable type
     */
    public static boolean isNullableMember(MemberShape shape) {
<span class="pc bpc" id="L130" title="2 of 4 branches missed.">        return !shape.isRequired() &amp;&amp; !shape.hasNonNullDefault();</span>
    }

    /**
     * Determines if a member targets a Map or List shape.
     *
     * @param model model used for code generation
     * @param member Shape to test
     * @return true if shape targets list or map shape
     */
    public static boolean targetsCollection(Model model, MemberShape member) {
<span class="nc" id="L141">        var target = model.expectShape(member.getTarget());</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">        return target.isListShape() || target.isMapShape();</span>
    }

    /**
     * Determines the name to use for the Schema constant for a member.
     *
     * @param memberName Member shape to generate schema name from
     * @return name to use for static schema property
     */
    public static String toMemberSchemaName(String memberName) {
<span class="fc" id="L152">        return SCHEMA_STATIC_NAME + &quot;_&quot; + CaseUtils.toSnakeCase(memberName).toUpperCase(Locale.ENGLISH);</span>
    }

    /**
     * Determines the name to use for shape Schemas.
     *
     * @param shape shape to generate name for
     * @return name to use for static schema property
     */
    public static String toSchemaName(Shape shape) {
        // Shapes that generate their own classes have a static name
<span class="pc bpc" id="L163" title="1 of 4 branches missed.">        if (shape.isOperationShape() || shape.isStructureShape()) {</span>
<span class="fc" id="L164">            return SCHEMA_STATIC_NAME;</span>
        }
<span class="fc" id="L166">        return CaseUtils.toSnakeCase(shape.toShapeId().getName()).toUpperCase(Locale.ENGLISH);</span>
    }

    /**
     * Writes the schema property to use for a given shape.
     *
     * &lt;p&gt;If a shape is a prelude shape then it will use a property from {@link PreludeSchemas}.
     * Otherwise, the shape will use the generated {@code SharedSchemas} utility class.
     *
     * @param writer Writer to use for writing the Schema type.
     * @param shape shape to write Schema type for.
     */
    public static String getSchemaType(JavaWriter writer, SymbolProvider provider, Shape shape) {
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (Prelude.isPreludeShape(shape)) {</span>
<span class="fc" id="L180">            return writer.format(&quot;$T.$L&quot;, PreludeSchemas.class, shape.getType().name());</span>
<span class="pc bpc" id="L181" title="1 of 4 branches missed.">        } else if (shape.isStructureShape() || shape.isUnionShape()) {</span>
            // Shapes that generate a class have their schemas as static properties on that class
<span class="fc" id="L183">            return writer.format(&quot;$T.$L&quot;, provider.toSymbol(shape), toSchemaName(shape));</span>
        }
<span class="fc" id="L185">        return writer.format(&quot;SharedSchemas.$L&quot;, toSchemaName(shape));</span>
    }

    /**
     * Sorts shape members to ensure that required members with no default value come before other members.
     *
     * @param shape Shape to sort members of
     * @return list of sorted members
     */
    public static List&lt;MemberShape&gt; getSortedMembers(Shape shape) {
<span class="fc" id="L195">        return shape.members()</span>
<span class="fc" id="L196">            .stream()</span>
<span class="fc" id="L197">            .sorted(</span>
                (a, b) -&gt; {
<span class="fc bfc" id="L199" title="All 4 branches covered.">                    if (isRequiredWithNoDefault(a) &amp;&amp; !isRequiredWithNoDefault(b)) {</span>
<span class="fc" id="L200">                        return -1;</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">                    } else if (isRequiredWithNoDefault(a)) {</span>
<span class="fc" id="L202">                        return 0;</span>
                    } else {
<span class="fc" id="L204">                        return 1;</span>
                    }
                }
            )
<span class="fc" id="L208">            .collect(Collectors.toList());</span>
    }

    /**
     * Checks if a member is required and has no default.
     *
     * &lt;p&gt;Required members with no default require presence tracking.
     *
     * @param memberShape member shape to check
     * @return true if the member has the required trait and does not have a default.
     */
    public static boolean isRequiredWithNoDefault(MemberShape memberShape) {
<span class="fc bfc" id="L220" title="All 4 branches covered.">        return memberShape.isRequired() &amp;&amp; !memberShape.hasNonNullDefault();</span>
    }

    /**
     * Checks if a member shape requires a null check in the builder setter.
     *
     * &lt;p&gt;Non-primitive, required members need a null check.
     */
    public static boolean requiresSetterNullCheck(SymbolProvider provider, MemberShape memberShape) {
<span class="pc bpc" id="L229" title="2 of 4 branches missed.">        return (memberShape.isRequired() || memberShape.hasNonNullDefault())</span>
<span class="pc bnc" id="L230" title="All 2 branches missed.">            &amp;&amp; !provider.toSymbol(memberShape).expectProperty(SymbolProperties.IS_PRIMITIVE);</span>
    }

    /**
     * Primitives (excluding blobs) use the Java default for error correction and so do not need to be set.
     *
     * &lt;p&gt;Documents are also not set because they use a null default for error correction.
     *
     * @see &lt;a href=&quot;https://smithy.io/2.0/spec/aggregate-types.html#client-error-correction&quot;&gt;client error correction&lt;/a&gt;
     * @return true if the member shape has a builtin default
     */
    public static boolean hasBuiltinDefault(SymbolProvider provider, Model model, MemberShape memberShape) {
<span class="nc" id="L242">        var target = model.expectShape(memberShape.getTarget());</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        return (provider.toSymbol(memberShape).expectProperty(SymbolProperties.IS_PRIMITIVE)</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            || target.isDocumentShape())</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            &amp;&amp; !target.isBlobShape();</span>
    }

    /**
     * Gets the name to use when defining the default value of a member.
     *
     * @param memberName name of member to get default name for.
     * @return Upper snake case name of default
     */
    public static String toDefaultValueName(String memberName) {
<span class="fc" id="L255">        return CaseUtils.toSnakeCase(memberName).toUpperCase(Locale.ENGLISH) + &quot;_DEFAULT&quot;;</span>
    }

    /**
     * Gets the file name to use for the SharedSerde utility class
     *
     * @param settings Settings to use for package namespace
     * @return serde file name
     */
    public static String getSerdeFileName(JavaCodegenSettings settings) {
<span class="fc" id="L265">        return String.format(&quot;./%s/model/SharedSerde.java&quot;, settings.packageNamespace().replace(&quot;.&quot;, &quot;/&quot;));</span>
    }

    /**
     * Gets the namespace to use for generated pojo files
     *
     * @param settings Settings to use for package namespace
     * @return schema file namespace
     */
    public static String getModelNamespace(JavaCodegenSettings settings) {
<span class="fc" id="L275">        return settings.packageNamespace() + &quot;.model&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>